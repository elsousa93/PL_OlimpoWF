{
    "className": "org.joget.apps.form.model.Form",
    "elements": [
        {
            "className": "org.joget.apps.form.model.Section",
            "elements": [{
                "className": "org.joget.apps.form.model.Column",
                "elements": [
                    {
                        "className": "org.joget.apps.form.lib.CustomHTML",
                        "properties": {
                            "autoPopulate": "",
                            "id": "field5",
                            "label": "",
                            "value": "<p class=\"jtitle20\">Workflow Processes<\/p>\n<hr>"
                        }
                    },
                    {
                        "className": "org.joget.apps.form.lib.HiddenField",
                        "properties": {
                            "elementUniqueKey": "3072",
                            "id": "instance_ids",
                            "value": "",
                            "workflowVariable": ""
                        }
                    },
                    {
                        "className": "org.joget.apps.form.lib.Grid",
                        "properties": {
                            "errorMessage": "No activity selected.",
                            "id": "reassignList",
                            "label": "",
                            "loadBinder": {
                                "className": "org.joget.apps.form.lib.BeanShellFormBinder",
                                "properties": {
                                    "autoHandleFiles": "",
                                    "autoHandleWorkflowVariable": "",
                                    "cacheInterval": "",
                                    "script": "import org.joget.apps.form.model.FormRowSet;\nimport org.joget.apps.form.model.FormRow;\nimport org.joget.apps.form.service.FormUtil;\nimport org.joget.commons.util.LogUtil;\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport javax.sql.DataSource;\nimport org.joget.apps.app.service.AppUtil;\n\npublic FormRowSet getData() {\n    FormRowSet results = new FormRowSet();\n    results.setMultiRow(true);\n    Connection con = null;\n    try {\n        // retrieve connection from the default datasource\n        DataSource ds = (DataSource)AppUtil.getApplicationContext().getBean(\"setupDataSource\");\n        con = ds.getConnection();\n\t    \n\t    if(!con.isClosed()){\n\t        String[] ids = \"#requestParam.fk_instance_ids#\".split(\";\"); \n\n\t            String sql = \"SELECT aa.name AS appName, p.Id AS processId, p.Name AS processName, p.ResourceRequesterId AS requester, \"; \n\t            sql += \"FROM_UNIXTIME(SUBSTRING(CAST(p.Started AS CHAR), 1, 10), '%Y-%m-%d %H:%i:%s') AS startTime \";\n\t            sql += \"FROM SHKProcesses p \";\n\t            sql += \"JOIN SHKProcessDefinitions pd ON pd.Name = p.PDefName \";\n\t            sql += \"LEFT JOIN app_package ap ON pd.PackageId = ap.packageId \";\n\t            sql += \"LEFT JOIN app_app aa ON aa.appId = ap.appId \"; \n\t            sql += \"WHERE p.Id IN (?\";\n                for (int i = 1; i < ids.length; i++) {\n                    sql += \",?\";\n                }\n                sql += \") GROUP BY pd.Name\";\n                \n                PreparedStatement stmt = con.prepareStatement(sql);\n                for (int i = 1; i <= ids.length; i++) {\n                    \n                    stmt.setObject(i, ids[i-1]);\n                }\n\t\t      \n\t\t        ResultSet rs = stmt.executeQuery();\n\t\t        while (rs.next()) {\n\t\t            FormRow row = new FormRow();\n\t\t            row.setId(rs.getString(2));\n\t\t            row.put(\"appName\", (rs.getString(1) != null)?rs.getString(1):\"\");\n\t\t            row.put(\"processId\", (rs.getString(2) != null)?rs.getString(2):\"\");\n\t\t            row.put(\"processName\", (rs.getString(3) != null)?rs.getString(3):\"\");\n\t\t            row.put(\"requester\", (rs.getString(4) != null)?rs.getString(4):\"\");\n\t\t            row.put(\"startTime\", (rs.getString(5) != null)?rs.getString(5):\"\");\n\t\t            results.add(row);\n\t\t        }\n\t\t    }\n        \n\n\t} catch(Exception ex) {\n\t    LogUtil.error(\"Exception\", ex, \"\");\n\t} finally {\n\t    try {\n            if(con != null)\n                con.close();\n        } catch(SQLException e) {}\n\t}    \n    return results;\n}\nreturn getData();",
                                    "useAjax": ""
                                }
                            },
                            "options": [
                                {
                                    "label": "App Name",
                                    "value": "appName"
                                },
                                {
                                    "label": "Process Name",
                                    "value": "processName"
                                },
                                {
                                    "label": "Requester",
                                    "value": "requester"
                                },
                                {
                                    "label": "Start Time",
                                    "value": "startTime"
                                }
                            ],
                            "permissionHidden": "",
                            "readonly": "true",
                            "storeBinder": {
                                "className": "org.joget.apps.form.lib.BeanShellFormBinder",
                                "properties": {
                                    "autoHandleFiles": "",
                                    "autoHandleWorkflowVariable": "",
                                    "cacheInterval": "",
                                    "script": "return null;",
                                    "useAjax": ""
                                }
                            },
                            "validateMaxRow": "",
                            "validateMinRow": "1",
                            "validator": {
                                "className": "",
                                "properties": {}
                            }
                        }
                    }
                ],
                "properties": {
                    "elementUniqueKey": "3069",
                    "width": "100%"
                }
            }],
            "properties": {
                "id": "section1",
                "label": "",
                "loadBinder": {
                    "className": "",
                    "properties": {}
                },
                "permission": {
                    "className": "",
                    "properties": {}
                },
                "regex": "",
                "storeBinder": {
                    "className": "",
                    "properties": {}
                },
                "visibilityControl": "",
                "visibilityValue": ""
            }
        },
        {
            "className": "org.joget.apps.form.model.Section",
            "elements": [{
                "className": "org.joget.apps.form.model.Column",
                "elements": [
                    {
                        "className": "org.joget.apps.form.lib.CustomHTML",
                        "properties": {
                            "autoPopulate": "",
                            "id": "field6",
                            "label": "",
                            "value": "<hr>\n<p class=\"jtitle20\">Select New Process to Start<\/p>\n<hr>"
                        }
                    },
                    {
                        "className": "org.joget.apps.form.lib.CustomHTML",
                        "properties": {
                            "autoPopulate": "",
                            "elementUniqueKey": "3083",
                            "id": "field3",
                            "label": "",
                            "validator": {
                                "className": "",
                                "properties": {}
                            },
                            "value": "<span style=\"color:blue;\"><i class=\"icon-info-sign\"><\/i> If no process is selected, it will start with the same process definition.<\/span>"
                        }
                    },
                    {
                        "className": "org.joget.apps.form.lib.SelectBox",
                        "properties": {
                            "controlField": "",
                            "elementUniqueKey": "3084",
                            "id": "process",
                            "label": "Process",
                            "multiple": "",
                            "options": [],
                            "optionsBinder": {
                                "className": "org.joget.apps.form.lib.BeanShellFormBinder",
                                "properties": {"script": "import org.joget.apps.form.model.FormRowSet;\nimport org.joget.apps.form.model.FormRow;\nimport org.joget.apps.form.service.FormUtil;\nimport org.joget.commons.util.LogUtil;\nimport org.joget.apps.app.service.AppUtil;\nimport org.joget.apps.app.service.AppService;\nimport org.joget.apps.app.model.AppDefinition;\nimport org.joget.workflow.model.WorkflowProcess;\n\npublic FormRowSet getData() {\n    FormRowSet results = new FormRowSet();\n    \n    FormRow erow = new FormRow();\n\terow.put(FormUtil.PROPERTY_VALUE, \"\");\n\terow.put(FormUtil.PROPERTY_LABEL, \"\");\n\tresults.add(erow);\n    \n    AppDefinition orgAppDef = AppUtil.getCurrentAppDefinition();\n    try {\n        AppService appService = (AppService) AppUtil.getApplicationContext().getBean(\"appService\");\n        Map appProcessMap = appService.getPublishedProcesses(null);\n\t\t\n\t\tif (appProcessMap != null) {\n\t\t    for (AppDefinition app: appProcessMap.keySet()) {\n\t\t        for (WorkflowProcess p : appProcessMap.get(app)) {\n\t\t            FormRow row = new FormRow();\n\t\t            row.put(FormUtil.PROPERTY_VALUE, p.getId());\n\t\t            row.put(FormUtil.PROPERTY_LABEL, app.getName() + \" - \" + p.getName());\n\t\t            results.add(row);\n\t\t        }\n\t\t    }\n\t\t}\n\t} catch(Exception ex) {\n\t    LogUtil.error(\"Exception\", ex, \"\");\n\t} finally {\n\t    AppUtil.setCurrentAppDefinition(orgAppDef);\n\t}  \n    return results;\n}\nreturn getData();"}
                            },
                            "readonly": "",
                            "readonlyLabel": "",
                            "size": "",
                            "validator": {
                                "className": "",
                                "properties": {}
                            },
                            "value": "",
                            "workflowVariable": ""
                        }
                    }
                ],
                "properties": {
                    "elementUniqueKey": "3080",
                    "width": "100%"
                }
            }],
            "properties": {
                "id": "section2",
                "label": "",
                "loadBinder": {
                    "className": "",
                    "properties": {}
                },
                "permission": {
                    "className": "",
                    "properties": {}
                },
                "regex": "",
                "storeBinder": {
                    "className": "",
                    "properties": {}
                },
                "visibilityControl": "",
                "visibilityValue": ""
            }
        }
    ],
    "properties": {
        "description": "",
        "id": "reiniciarProcesso",
        "loadBinder": {
            "className": "org.joget.apps.form.lib.WorkflowFormBinder",
            "properties": {}
        },
        "name": "Reiniciar Processo",
        "noPermissionMessage": "",
        "permission": {
            "className": "",
            "properties": {}
        },
        "postProcessor": {
            "className": "",
            "properties": {}
        },
        "postProcessorRunOn": "create",
        "storeBinder": {
            "className": "org.joget.apps.form.lib.BeanShellFormBinder",
            "properties": {
                "autoHandleFiles": "",
                "autoHandleWorkflowVariable": "",
                "cacheInterval": "",
                "script": "import org.joget.apps.form.model.FormRowSet;\nimport org.joget.apps.form.model.FormRow;\nimport org.joget.workflow.model.service.WorkflowManager;\nimport org.joget.workflow.model.WorkflowProcess;\nimport org.joget.apps.app.service.AppUtil;\nimport org.joget.workflow.model.WorkflowProcessLink;\nimport org.joget.workflow.model.WorkflowProcessResult;\nimport org.joget.apps.app.model.AppDefinition;\nimport org.joget.commons.util.LogUtil;\nimport java.sql.Connection;\nimport java.sql.PreparedStatement;\nimport java.sql.ResultSet;\nimport java.sql.SQLException;\nimport javax.sql.DataSource;\n\npublic FormRowSet storeData() {\n    AppDefinition appDef = AppUtil.getCurrentAppDefinition();\n    FormRow row = rows.get(0);\n    \n    String instanceId = \"#requestParam.id#\";\n    String ids = row.get(\"instance_ids\");\n    String processDefId = row.get(\"process\");\n    \n    String[] idList = ids.split(\";\");\n    for (String id : idList) {\n        String recordId = id;\n        WorkflowManager wm = (WorkflowManager) AppUtil.getApplicationContext().getBean(\"workflowManager\");\n        \n        WorkflowProcessLink link = wm.getWorkflowProcessLink(id);\n        if (link != null) {\n            recordId = link.getOriginProcessId();\n        }\n        \n        WorkflowProcess process = wm.getRunningProcessById(id);\n        if (process != null) {\n            String tempProcessDefId = processDefId;\n            if (tempProcessDefId.isEmpty()) {\n                tempProcessDefId = process.getId().replaceAll(\"#.+#\", \"#latest#\");\n            }\n            \n            \n            \n            Connection con = null;\n            PreparedStatement stmt = null;\n            ResultSet rs = null;\n            \n            \n            LogUtil.info(\"Old RecordId\", \"AAA\" + recordId);\n            LogUtil.info(\"New RecordId\", \"AAA\" + newProcessId);\n            \n            try{\n                \n\n                DataSource ds = (DataSource)AppUtil.getApplicationContext().getBean(\"setupDataSource\");\n                con = ds.getConnection();\n                \n                if(!con.isClosed()){\n                    \n                    String complexidadeValor = \"NOR\";\n                    String estado = \"ATV\";\n                    String bancoValor = \"\";\n                    String origemProcesso = \"\";\n                    \n                    String queryGetVariables = \"SELECT c_nome_banco, c_origem_processo FROM app_fd_detalhe_processo WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryGetVariables);\n                    stmt.setObject(1, recordId);\n                    rs = stmt.executeQuery();\n                    \n                    if(rs.next()){\n                        bancoValor = rs.getObject(\"c_nome_banco\");\n                        origemProcesso = rs.getObject(\"c_origem_processo\");\n                    }\n                    \n                    \n                    Map variables = new HashMap();\n                    variables.put(\"banco\", bancoValor);\n                    variables.put(\"estado\", estado);\n                    variables.put(\"complexidade\", complexidadeValor);\n                    variables.put(\"origem\", origemProcesso);\n                    \n                    //WorkflowProcessResult result = wm.processStart(tempProcessDefId, null, null, process.getRequesterId(), recordId, false);\n                    WorkflowProcessResult result = wm.processStart(tempProcessDefId, variables);\n                    String newProcessId = result.getProcess().getInstanceId();\n            \n                    \n                    //Tabela Processos\n                    String queryProcesso = \"UPDATE app_fd_processos SET id = ? WHERE id = ?\";\n                    stmt = con.prepareStatement(queryProcesso);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //tabela detalhe de Processo\n                    String queryDetalheProcesso = \"UPDATE app_fd_detalhe_processo SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryDetalheProcesso);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela intervenientes\n                    String queryIntervenientes= \"UPDATE app_fd_interv_processo SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryIntervenientes);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela intervenientesProcesso\n                    String queryIntervenientes= \"UPDATE app_fd_intervenientes_proc SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryIntervenientes);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n\n                    //Tabela Imóveis\n                    String queryImovel= \"UPDATE app_fd_imoveis SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryImovel);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela Documentos\n                    String queryDocumentos= \"UPDATE app_fd_docs_processo SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryDocumentos);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela tipos de documentos      \n                    String queryIntervenientes= \"UPDATE app_fd_documento_processo SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryIntervenientes);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    \n                    //Tabela banco\n                    String queryBanco= \"UPDATE app_fd_banco SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryBanco);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela analise bancária\n                    String queryBanco= \"UPDATE app_fd_anal_banc_processo SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryBanco);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela análise legal\n                    String queryBanco= \"UPDATE app_fd_anal_legal_processo SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryBanco);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela esclarecimentos\n                    String queryBanco= \"UPDATE app_fd_esclarecimentos SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryBanco);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela Comunicações\n                    String queryBanco= \"UPDATE app_fd_comunicacoes_proce SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryBanco);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela agendamento\n                    String queryBanco= \"UPDATE app_fd_agendamento SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryBanco);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n                    \n                    //Tabela Geral\n                    String queryBanco= \"UPDATE app_fd_geral SET c_id_processo = ? WHERE c_id_processo = ?\";\n                    stmt = con.prepareStatement(queryBanco);\n                    stmt.setObject(1, newProcessId);\n                    stmt.setObject(2, recordId);\n                    stmt.executeQuery();\n\n                    //String variableList = wm.getProcessVariable(recordId);\n                   // LogUtil.info(\"Variable List \" ,  \"AAAAAAaa - \" +  variableList);\n                    \n                    \n                }\n            \n            }catch(Exception e){\n                LogUtil.error(appDef.toString(), e, \"Reiniciar processo\");\n            }finally{\n                try{\n                    if(rs != null){\n                    rs.close();\n                    }\n                    if(stmt != null){\n                        stmt.close();\n                    }\n                    if(con != null && !con.isClosed()) {\n                        con.close();\n                    }\n                }catch(Exception e){\n                    LogUtil.error(appDef.toString(), e, \"Error closing DB connection\");\n                }\n                \n            }\n        }\n    }\n    return rows;\n}\n\nreturn storeData();\n",
                "useAjax": ""
            }
        },
        "tableName": "restart_process"
    }
}